@model CareerPilotAi.ViewModels.JobApplication.JobApplicationDetailsViewModel
@using CareerPilotAi.ViewModels.JobApplication
@{
    ViewData["Title"] = Model.JobTitle + " - " + Model.CompanyName;
    
    // Helper function to get CSS class from status
    string GetStatusCssClass(string status)
    {
        var output = $"status-{status?.ToLower()?.Replace(" ", "-")}";
        return output;
    }
    
    // Helper function to get CSS class from skill level
    string GetSkillCssClass(SkillViewModel skill)
    {
        if (string.IsNullOrEmpty(skill?.Level))
            return "skill-badge-regular";

        return skill.Level.ToLowerInvariant() switch
        {
            "nicetoha" => "skill-badge-nice-to-have",
            "junior" => "skill-badge-nice-to-have",
            "regular" => "skill-badge-regular",
            "advanced" => "skill-badge-advanced",
            "master" => "skill-badge-master",
            _ => "skill-badge-regular"
        };
    }
}

<link href="~/css/interview-questions.css" rel="stylesheet" />

@Html.AntiForgeryToken()

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center gap-3">
                    <div>
                        <h2 class="mb-0">@Model.JobTitle</h2>
                        <p class="text-muted mb-0">@Model.CompanyName</p>
                    </div>
                    <!-- Status Dropdown -->
                    <div class="dropdown">
                        <button class="btn dropdown-toggle d-flex align-items-center gap-2" 
                                type="button" 
                                id="statusDropdown" 
                                data-bs-toggle="dropdown" 
                                aria-expanded="false">
                            <span class="status-dot @GetStatusCssClass(Model.Status)"></span>
                            <span class="status-text">@Model.Status</span>
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="statusDropdown">
                            <li><a class="dropdown-item d-flex align-items-center gap-2" href="#" data-status="Draft" data-color-class="status-draft">
                                <span class="status-dot status-draft"></span>Draft
                            </a></li>
                            <li><a class="dropdown-item d-flex align-items-center gap-2" href="#" data-status="Submitted" data-color-class="status-submitted">
                                <span class="status-dot status-submitted"></span>Submitted
                            </a></li>
                            <li><a class="dropdown-item d-flex align-items-center gap-2" href="#" data-status="Interview Scheduled" data-color-class="status-interview-scheduled">
                                <span class="status-dot status-interview-scheduled"></span>Interview Scheduled
                            </a></li>
                            <li><a class="dropdown-item d-flex align-items-center gap-2" href="#" data-status="Waiting for offer" data-color-class="status-waiting-for-offer">
                                <span class="status-dot status-waiting-for-offer"></span>Waiting for offer
                            </a></li>
                            <li><a class="dropdown-item d-flex align-items-center gap-2" href="#" data-status="Received offer" data-color-class="status-received-offer">
                                <span class="status-dot status-received-offer"></span>Received offer
                            </a></li>
                            <li><a class="dropdown-item d-flex align-items-center gap-2" href="#" data-status="Rejected" data-color-class="status-rejected">
                                <span class="status-dot status-rejected"></span>Rejected
                            </a></li>
                            <li><a class="dropdown-item d-flex align-items-center gap-2" href="#" data-status="No contact" data-color-class="status-no-contact">
                                <span class="status-dot status-no-contact"></span>No contact
                            </a></li>
                        </ul>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <a href="/job-applications" class="btn btn-outline-secondary px-4">
                        <i class="fas fa-arrow-left"></i> <span class="ms-2">Back</span>
                    </a>
                    <a href="@Url.Action("Edit", "JobApplication", new { id = Model.JobApplicationId })" class="btn btn-outline-primary">
                        <i class="fas fa-edit me-2"></i>Edit
                    </a>
                    <button type="button" 
                            class="btn btn-outline-danger" 
                            onclick="confirmDelete('@Model.JobApplicationId', '@Model.JobTitle')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="jobApplicationTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="job-details-tab" data-bs-toggle="tab" data-bs-target="#job-details" type="button" role="tab" data-tab-param="job-details">
                        <i class="fas fa-briefcase me-2"></i>Job Details
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="interview-questions-tab" data-bs-toggle="tab" data-bs-target="#interview-questions" type="button" role="tab" data-tab-param="interview-questions">
                        <i class="fas fa-question-circle me-2"></i>Interview Questions
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="jobApplicationTabContent">
                <!-- Job Details Tab -->
                <div class="tab-pane fade show active" id="job-details" role="tabpanel">
                    <div class="row mt-4">
                        <!-- Left Column: Main Content -->
                        <div class="col-lg-8">
                            <!-- Job Description Card -->
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Job Description & Requirements</h5>
                                    <pre class="job-description-display">@Model.JobDescription</pre>
                                </div>
                            </div>

                            <!-- Skills Card -->
                            @if (Model.Skills != null && Model.Skills.Any())
                            {
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Required Skills</h5>
                                        <div class="skills-container">
                                            @foreach (var skill in Model.Skills)
                                            {
                                                <span class="badge @GetSkillCssClass(skill) me-2 mb-2">
                                                    @skill.Name
                                                </span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="card">
                                    <div class="card-body">
                                        <p class="text-muted mb-0">No skills specified</p>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Right Column: Sidebar Information -->
                        <div class="col-lg-4">
                            <!-- Key Information Card -->
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Key Information</h5>
                                    <div class="info-item mb-1">
                                        <small class="text-muted d-block">Experience Level</small>
                                        <i class="fas fa-chart-line me-2 text-primary"></i>
                                        <span>@Model.ExperienceLevel</span>
                                    </div>
                                    <div class="info-item mb-1">
                                        <small class="text-muted d-block">Location</small>
                                        <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                        <span>@Model.Location</span>
                                    </div>
                                    <div class="info-item mb-1">
                                        <small class="text-muted d-block">Work Mode</small>
                                        <i class="fas fa-laptop me-2 text-primary"></i>
                                        <span>@Model.WorkMode</span>
                                    </div>
                                    <div class="info-item">
                                        <small class="text-muted d-block">Contract Type</small>
                                        <i class="fas fa-handshake me-2 text-primary"></i>
                                        <span>@Model.ContractType</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Salary Information Card -->
                            @if (Model.SalaryMin.HasValue)
                            {
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">Salary Information</h5>
                                        <div class="info-item mb-1">
                                            <small class="text-muted d-block">Range</small>
                                            <i class="fas fa-money-bill-wave me-2 text-success"></i>
                                            <span>
                                                @Model.SalaryMin?.ToString("N0") PLN - @Model.SalaryMax?.ToString("N0") PLN
                                            </span>
                                        </div>
                                        @if (!string.IsNullOrEmpty(Model.SalaryType))
                                        {
                                            <div class="info-item mb-1">
                                                <small class="text-muted d-block">Type</small>
                                                <span>@(Model.SalaryType?.ToLowerInvariant() == "gross" ? "Gross" : "Net")</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(Model.SalaryPeriod))
                                        {
                                            <div class="info-item">
                                                <small class="text-muted d-block">Period</small>
                                                <span>@Model.SalaryPeriod</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }

                            <!-- Additional Information Card -->
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Additional Information</h5>
                                    @if (!string.IsNullOrEmpty(Model.JobUrl))
                                    {
                                        <div class="info-item mb-1">
                                            <small class="text-muted d-block">Job URL</small>
                                            <a href="@Model.JobUrl" target="_blank" rel="noopener noreferrer" class="text-primary">
                                                <i class="fas fa-external-link-alt me-1"></i>View Offer
                                            </a>
                                        </div>
                                    }
                                    <div class="info-item mb-1">
                                        <small class="text-muted d-block">Created</small>
                                        <i class="fas fa-calendar me-2 text-info"></i>
                                        <span>@Model.CreatedAt.ToString("dd MMMM yyyy, HH:mm")</span>
                                    </div>
                                    <div class="info-item">
                                        <small class="text-muted d-block">Last Updated</small>
                                        <i class="fas fa-calendar me-2 text-info"></i>
                                        <span>@Model.UpdatedAt.ToString("dd MMMM yyyy, HH:mm")</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Interview Questions Tab -->
                @await Html.PartialAsync("_InterviewQuestionsTab", Model)
            </div>
        </div>
    </div>
</div>

<style>
    /* Status Dropdown Styling */
    #statusDropdown {
        min-width: 160px;
        border-color: #e9ecef;
    }

    #statusDropdown:hover {
        border-color: #007bff;
    }

    .dropdown-menu .dropdown-item {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    .dropdown-menu .dropdown-item:hover {
        background-color: #f8f9fa;
    }

    .job-description-display {
        white-space: pre-wrap;
        word-break: break-word;
        overflow-wrap: anywhere;
        border: 1px solid #e9ecef;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #f8f9fa;
        max-height: 500px;
        overflow-y: auto;
        overflow-x: hidden;
        line-height: 1.6;
        font-size: 0.9rem;
    }

    /* Skill Badge Styles */
    .skill-badge-nice-to-have {
        background-color: #6c757d;
        color: white;
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }

    .skill-badge-regular {
        background-color: #0d6efd;
        color: white;
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }

    .skill-badge-advanced {
        background-color: #fd7e14;
        color: white;
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }

    .skill-badge-master {
        background-color: #ffc107;
        color: #212529;
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }

    .skills-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    /* Info Item Styling */
    .info-item {
        padding: 0.5rem 0;
    }

    .info-item small {
        font-weight: 500;
        letter-spacing: 0.5px;
    }

    .info-item span {
        font-size: 0.95rem;
    }

    .tab-content {
        min-height: 500px;
    }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .d-flex.justify-content-between.align-items-center.mb-4 {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }
        
        .d-flex.align-items-center.gap-3 {
            flex-direction: column;
            align-items: stretch;
            gap: 1rem;
        }
        
        #statusDropdown {
            min-width: 100%;
        }

        .col-lg-8, .col-lg-4 {
            flex: 0 0 100%;
            max-width: 100%;
        }
    }
</style>

@section Scripts {
    <script src="~/js/interview-questions.js"></script>
    <script>
        $(document).ready(function() {
            // ===========================================
            // VARIABLE DECLARATIONS
            // ===========================================
            
            let originalJobDescription = @Html.Raw(Json.Serialize(Model.JobDescription));
            
            // Initialize Interview Questions Manager
            const interviewQuestionsManager = new InterviewQuestionsManager({
                jobApplicationId: '@Model.JobApplicationId',
                originalJobDescription: originalJobDescription,
                showSuccessMessage: showSuccessMessage,
                showErrorMessage: showErrorMessage
            });
            
            // ===========================================
            // TAB MANAGEMENT SYSTEM (Query Parameter-based)
            // ===========================================
            
            const TabManager = {
                defaultTab: 'job-details',
                paramName: 'tab',
                
                tabConfigs: {
                    'job-details': {
                        tabSelector: '#job-details-tab',
                        contentSelector: '#job-details',
                        onActivate: function() {
                            // Job details specific initialization if needed
                        }
                    },
                    'interview-questions': {
                        tabSelector: '#interview-questions-tab',
                        contentSelector: '#interview-questions',
                        onActivate: function() {
                            interviewQuestionsManager.onTabActivate();
                        }
                    }
                },
                
                init: function() {
                    this.bindEvents();
                    this.activateTabFromUrl();
                },
                
                bindEvents: function() {
                    const self = this;
                    
                    $('#jobApplicationTabs button[data-bs-toggle="tab"]').on('click', function(e) {
                        e.preventDefault();
                        
                        const tabParam = $(this).data('tab-param');
                        if (tabParam) {
                            self.updateUrlParameter(tabParam);
                            self.activateTab(tabParam);
                        }
                        interviewQuestionsManager.clearTabMessages();
                    });
                    
                    $(window).on('popstate', function() {
                        self.activateTabFromUrl();
                    });
                    
                    $('#jobApplicationTabs button[data-bs-toggle="tab"]').on('shown.bs.tab', function(e) {
                        const tabParam = $(e.target).data('tab-param');
                        const config = self.tabConfigs[tabParam];
                        if (config && config.onActivate) {
                            config.onActivate();
                        }
                    });
                },
                
                getUrlParams: function() {
                    return new URLSearchParams(window.location.search);
                },
                
                getCurrentTabFromUrl: function() {
                    return this.getUrlParams().get(this.paramName);
                },
                
                updateUrlParameter: function(tabParam) {
                    const url = new URL(window.location);
                    
                    if (tabParam === this.defaultTab) {
                        url.searchParams.delete(this.paramName);
                    } else {
                        url.searchParams.set(this.paramName, tabParam);
                    }
                    
                    window.history.pushState({ tab: tabParam }, '', url);
                },
                
                activateTabFromUrl: function() {
                    const currentTab = this.getCurrentTabFromUrl();
                    const targetTab = currentTab && this.tabConfigs[currentTab] ? currentTab : this.defaultTab;
                    
                    this.activateTab(targetTab);
                },
                
                activateTab: function(tabParam) {
                    const config = this.tabConfigs[tabParam];
                    if (!config) {
                        console.warn(`Tab configuration not found for: ${tabParam}`);
                        return;
                    }
                    
                    $('#jobApplicationTabs .nav-link').removeClass('active');
                    $('.tab-pane').removeClass('show active');
                    
                    $(config.tabSelector).addClass('active');
                    $(config.contentSelector).addClass('show active');
                    
                    $(config.tabSelector).trigger('shown.bs.tab');
                },
                
                addTab: function(tabParam, config) {
                    this.tabConfigs[tabParam] = config;
                },
                
                navigateToTab: function(tabParam) {
                    if (this.tabConfigs[tabParam]) {
                        this.updateUrlParameter(tabParam);
                        this.activateTab(tabParam);
                    }
                }
            };
            
            TabManager.init();
            
            // ===========================================
            // STATUS DROPDOWN FUNCTIONALITY
            // ===========================================
            
            $('.dropdown-menu .dropdown-item').on('click', function(e) {
                e.preventDefault();
                
                const newStatus = $(this).data('status');
                const newColorClass = $(this).data('color-class');
                
                const $statusButton = $('#statusDropdown');
                const $statusDot = $statusButton.find('.status-dot');
                const $statusText = $statusButton.find('.status-text');
                
                $statusDot.removeClass('status-draft status-submitted status-interview-scheduled status-waiting-for-offer status-received-offer status-rejected status-no-contact');
                $statusDot.addClass(newColorClass);
                $statusText.text(newStatus);
                
                updateApplicationStatus('@Model.JobApplicationId', newStatus);
            });
            
            async function updateApplicationStatus(jobApplicationId, newStatus) {
                try {
                    const response = await fetch(`/job-applications/api/status/${jobApplicationId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                        },
                        body: JSON.stringify({
                            Status: newStatus
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        const errorMessage = errorData.detail || errorData.error || 'Failed to update application status. Please try again.';
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    showSuccessMessage(`Application status updated to "${newStatus}" successfully!`);
                } catch (error) {
                    console.error('Error updating application status:', error);
                    showErrorMessage(error.message);
                    location.reload();
                }
            }
            
            interviewQuestionsManager.init();
            
            if (typeof bootstrap !== 'undefined') {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
            
            // ===========================================
            // SHARED UTILITY FUNCTIONS
            // ===========================================
            
            function showSuccessMessage(message) {
                const successHtml = `
                    <div class="alert alert-success alert-dismissible fade show mt-2" role="alert">
                        <i class="fas fa-check-circle me-2"></i>${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                const $jobDetailsDiv = $('#job-details');
                if ($jobDetailsDiv.length) {
                    $jobDetailsDiv.prepend(successHtml);
                } else {
                    $('body').prepend(successHtml);
                }
                
                setTimeout(() => {
                    $('.alert-success').fadeOut();
                }, 8000);
            }
            
            function showErrorMessage(message) {
                const errorHtml = `
                    <div class="alert alert-danger alert-dismissible fade show mt-2" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                const $jobDetailsDiv = $('#job-details');
                if ($jobDetailsDiv.length) {
                    $jobDetailsDiv.prepend(errorHtml);
                } else {
                    $('body').prepend(errorHtml);
                }
                
                setTimeout(() => {
                    $('.alert-danger').fadeOut();
                }, 8000);
            }
        });

        function confirmDelete(jobApplicationId, jobTitle) {
            if (confirm(`Are you sure you want to delete the job application for "${jobTitle}"? This action cannot be undone.`)) {
                deleteJobApplication(jobApplicationId);
            }
        }

        async function deleteJobApplication(jobApplicationId) {
            try {
                const response = await fetch(`/job-applications/api/delete/${jobApplicationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    window.location.href = '/job-applications';
                } else {
                    const errorData = await response.json();
                    alert(errorData.detail || 'An error occurred while deleting the job application.');
                }
            } catch (error) {
                console.error('Error deleting job application:', error);
                alert('An error occurred while deleting the job application. Please try again.');
            }
        }
    </script>
}