@model CareerPilotAi.Models.JobApplication.JobApplicationDetailsViewModel
@{
    ViewData["Title"] = Model.JobTitle + " - " + Model.CompanyName;
}

<link href="~/css/interview-questions.css" rel="stylesheet" />

@Html.AntiForgeryToken()

<div class="container-fluid">
    <div class="row">
        <div class="col-12">            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">@Model.JobTitle</h2>
                    <p class="text-muted mb-0">@Model.CompanyName</p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" 
                            class="btn btn-outline-danger" 
                            onclick="confirmDelete('@Model.JobApplicationId', '@Model.JobTitle')">
                        <i class="fas fa-trash me-2"></i>Delete Application
                    </button>
                    <a href="/job-applications" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Applications
                    </a>
                </div>
            </div>

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs" id="jobApplicationTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="job-details-tab" data-bs-toggle="tab" data-bs-target="#job-details" type="button" role="tab" data-tab-param="job-details">
                        <i class="fas fa-briefcase me-2"></i>Job Details
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="interview-questions-tab" data-bs-toggle="tab" data-bs-target="#interview-questions" type="button" role="tab" data-tab-param="interview-questions">
                        <i class="fas fa-question-circle me-2"></i>Interview Questions
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="jobApplicationTabContent">
                <!-- Job Details Tab -->
                <div class="tab-pane fade" id="job-details" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-body">
                            <!-- Tab-specific message container -->
                            <div id="jobDetailsMessages"></div>
                            
                            <label class="form-label fw-bold">Job Description & Requirements</label>
                            
                            <!-- Display Mode -->
                            <div id="jobDescriptionDisplay" class="job-description-display">
                                @Html.Raw(Model.JobDescription.Replace("\n", "<br>"))
                            </div>
                            
                            <!-- Edit Mode -->
                            <div id="jobDescriptionEdit" style="display: none;">
                                <textarea id="jobDescriptionTextArea" class="form-control" rows="15">@Model.JobDescription</textarea>
                                <div class="mt-2">
                                    <div class="text-muted">Word count: <span id="wordCount">0</span> / 5,000</div>
                                </div>
                                <div id="wordLimitError" class="text-danger mt-1" style="display: none;">
                                    Text exceeds the maximum limit of 5,000 words. Please shorten your text to continue.
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="mt-3">
                                <div id="editActions">
                                    <button type="button" class="btn btn-outline-primary me-2" id="editJobDescriptionBtn">
                                        <i class="fas fa-edit me-2"></i>Edit
                                    </button>
                                </div>
                                <div id="saveActions" style="display: none;">
                                    <button type="button" class="btn btn-success me-2" id="saveJobDescriptionBtn">
                                        <i class="fas fa-save me-2"></i>Save
                                    </button>
                                    <button type="button" class="btn btn-secondary me-2" id="cancelEditBtn">
                                        <i class="fas fa-times me-2"></i>Cancel
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="enhanceJobDescriptionBtn" title="Enhance the Job Description with AI">
                                        <i class="fas fa-wand-magic-sparkles me-2"></i>Enhance with AI
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Interview Questions Tab -->
                @await Html.PartialAsync("_InterviewQuestionsTab", Model)
            </div>
        </div>
    </div>
</div>

<style>
    .job-description-display {
        word-wrap: break-word;
        border: 1px solid #e9ecef;
        border-radius: 0.375rem;
        padding: 1rem;
        background-color: #f8f9fa;
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
        line-height: 1.6;
    }
    
    .tab-content {
        min-height: 500px;
    }
</style>

@section Scripts {
    <script src="~/js/word-counter.js"></script>
    <script src="~/js/interview-questions.js"></script>
    <script>
        $(document).ready(function() {
            // ===========================================
            // VARIABLE DECLARATIONS (must be at top for tab initialization)
            // ===========================================
            
            let originalJobDescription = @Html.Raw(Json.Serialize(Model.JobDescription));
            let wordCounter;
            
            // Initialize Interview Questions Manager
            const interviewQuestionsManager = new InterviewQuestionsManager({
                jobApplicationId: '@Model.JobApplicationId',
                originalJobDescription: originalJobDescription,
                showSuccessMessage: showSuccessMessage,
                showErrorMessage: showErrorMessage
            });
            
            // ===========================================
            // TAB MANAGEMENT SYSTEM (Query Parameter-based)
            // ===========================================
            
            const TabManager = {
                defaultTab: 'job-details',
                paramName: 'tab',
                
                // Configuration for all tabs - easily extendable for future tabs
                tabConfigs: {
                    'job-details': {
                        tabSelector: '#job-details-tab',
                        contentSelector: '#job-details',
                        onActivate: function() {
                            // Job details specific initialization if needed
                        }
                    },
                    'interview-questions': {
                        tabSelector: '#interview-questions-tab',
                        contentSelector: '#interview-questions',
                        onActivate: function() {
                            interviewQuestionsManager.onTabActivate();
                        }
                    }
                },
                
                // Initialize tab management system
                init: function() {
                    this.bindEvents();
                    this.activateTabFromUrl();
                },
                
                // Bind events for tab management
                bindEvents: function() {
                    const self = this;
                    
                    // Handle tab clicks to update URL parameters
                    $('#jobApplicationTabs button[data-bs-toggle="tab"]').on('click', function(e) {
                        e.preventDefault(); // Prevent default Bootstrap behavior temporarily
                        
                        const tabParam = $(this).data('tab-param');
                        if (tabParam) {
                            self.updateUrlParameter(tabParam);
                            self.activateTab(tabParam);
                        }
                        interviewQuestionsManager.clearTabMessages();
                    });
                    
                    // Handle browser back/forward buttons
                    $(window).on('popstate', function() {
                        self.activateTabFromUrl();
                    });
                    
                    // Handle Bootstrap tab shown event for custom logic
                    $('#jobApplicationTabs button[data-bs-toggle="tab"]').on('shown.bs.tab', function(e) {
                        const tabParam = $(e.target).data('tab-param');
                        const config = self.tabConfigs[tabParam];
                        if (config && config.onActivate) {
                            config.onActivate();
                        }
                    });
                },
                
                // Get URL search parameters
                getUrlParams: function() {
                    return new URLSearchParams(window.location.search);
                },
                
                // Get current tab from URL parameter
                getCurrentTabFromUrl: function() {
                    return this.getUrlParams().get(this.paramName);
                },
                
                // Update URL parameter without page reload
                updateUrlParameter: function(tabParam) {
                    const url = new URL(window.location);
                    
                    if (tabParam === this.defaultTab) {
                        // Remove tab parameter for default tab to keep URL clean
                        url.searchParams.delete(this.paramName);
                    } else {
                        url.searchParams.set(this.paramName, tabParam);
                    }
                    
                    // Update URL without triggering page reload
                    window.history.pushState({ tab: tabParam }, '', url);
                },
                
                // Activate tab based on current URL parameter
                activateTabFromUrl: function() {
                    const currentTab = this.getCurrentTabFromUrl();
                    const targetTab = currentTab && this.tabConfigs[currentTab] ? currentTab : this.defaultTab;
                    
                    // Activate the target tab
                    this.activateTab(targetTab);
                },
                
                // Activate specific tab programmatically
                activateTab: function(tabParam) {
                    const config = this.tabConfigs[tabParam];
                    if (!config) {
                        console.warn(`Tab configuration not found for: ${tabParam}`);
                        return;
                    }
                    
                    // Remove active classes from all tabs and content
                    $('#jobApplicationTabs .nav-link').removeClass('active');
                    $('.tab-pane').removeClass('show active');
                    
                    // Activate the target tab and content
                    $(config.tabSelector).addClass('active');
                    $(config.contentSelector).addClass('show active');
                    
                    // Trigger Bootstrap's shown event manually for custom logic
                    $(config.tabSelector).trigger('shown.bs.tab');
                },
                
                // Helper method to add new tab configuration (for future extensibility)
                addTab: function(tabParam, config) {
                    this.tabConfigs[tabParam] = config;
                },
                
                // Helper method to navigate to a specific tab programmatically
                navigateToTab: function(tabParam) {
                    if (this.tabConfigs[tabParam]) {
                        this.updateUrlParameter(tabParam);
                        this.activateTab(tabParam);
                    }
                }
            };
            
            // Initialize the tab management system
            TabManager.init();
            
            // Initialize Interview Questions Manager
            interviewQuestionsManager.init();
            
            // Initialize Bootstrap tooltips
            if (typeof bootstrap !== 'undefined') {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            }
            
            // ===========================================
            // JOB DESCRIPTION FUNCTIONALITY
            // ===========================================
            
            // Initialize word counter when entering edit mode
            function initializeWordCounter() {
                wordCounter = new WordCounter({
                    textAreaSelector: '#jobDescriptionTextArea',
                    wordCountSelector: '#wordCount',
                    maxWords: 5000,
                    warningThreshold: 4000,
                    submitButtonSelector: '#saveJobDescriptionBtn',
                    errorMessageSelector: '#wordLimitError'
                });
            }
            
            // Edit button click
            $('#editJobDescriptionBtn').on('click', function() {
                $('#jobDescriptionDisplay').hide();
                $('#jobDescriptionEdit').show();
                $('#editActions').hide();
                $('#saveActions').show();
                
                // Initialize word counter
                initializeWordCounter();
                
                // Focus on textarea
                $('#jobDescriptionTextArea').focus();
            });
            
            // Enhance with AI button click
            $('#enhanceJobDescriptionBtn').on('click', function(e) {
                e.preventDefault();
                
                const $button = $(this);
                const jobDescriptionDisplay = $('#jobDescriptionDisplay');
                
                // Extract plain text from display (remove HTML br tags)
                let jobDescriptionText = jobDescriptionDisplay.html();
                if (jobDescriptionText) {
                    // Convert HTML br tags back to newlines and strip HTML
                    jobDescriptionText = jobDescriptionText.replace(/<br\s*\/?>/gi, '\n');
                    jobDescriptionText = $('<div>').html(jobDescriptionText).text().trim();
                }
                
                // Clear previous messages
                clearTabMessages();
                
                if (!jobDescriptionText) {
                    showErrorMessage('No job description content available to enhance.', 'jobDetailsMessages');
                    return;
                }
                
                // Show loading state
                showEnhanceLoadingState($button);
                
                // Create AbortController for timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 40000); // 40 seconds
                
                // Make Fetch API request
                fetch('/job-applications/api/enhance-job-description', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({
                        JobDescriptionText: jobDescriptionText
                    }),
                    signal: controller.signal
                })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            // Handle ProblemDetails response format
                            const errorMessage = errorData.detail || errorData.error || 'Something went wrong. Please try again or provide different text content.';
                            throw new Error(errorMessage);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.content) {
                        // Update both display and textarea with enhanced content
                        const enhancedContent = data.content;
                        
                        // Update display mode (convert newlines to br tags)
                        $('#jobDescriptionDisplay').html(enhancedContent.replace(/\n/g, '<br>'));
                        
                        // Update edit mode textarea (keep as plain text)
                        $('#jobDescriptionTextArea').val(enhancedContent);
                        
                        // Update the original variable so cancel works correctly
                        originalJobDescription = enhancedContent;
                        
                        // Update the Interview Questions Manager with the enhanced job description
                        interviewQuestionsManager.updateJobDescription(enhancedContent);
                        
                        // Show success message
                        showSuccessMessage('Job description enhanced successfully!', 'jobDetailsMessages');
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        showErrorMessage('Request timed out. Please try again with a shorter text or check your connection.', 'jobDetailsMessages');
                    } else {
                        showErrorMessage(error.message, 'jobDetailsMessages');
                    }
                })
                .finally(() => {
                    hideEnhanceLoadingState($button);
                });
            });

            // Cancel button click
            $('#cancelEditBtn').on('click', function() {
                // Reset textarea to original value
                $('#jobDescriptionTextArea').val(originalJobDescription);
                
                // Switch back to display mode
                $('#jobDescriptionDisplay').show();
                $('#jobDescriptionEdit').hide();
                $('#editActions').show();
                $('#saveActions').hide();
            });
            
            // Save button click
            $('#saveJobDescriptionBtn').on('click', function() {
                const $button = $(this);
                const newJobDescription = $('#jobDescriptionTextArea').val().trim();
                
                // Validate word count
                if (wordCounter && !wordCounter.validateWordCount().isValid) {
                    return;
                }
                
                if (!newJobDescription) {
                    alert('Job description cannot be empty.');
                    return;
                }
                
                // Show loading state
                $button.prop('disabled', true);
                $button.html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...');
                
                // Make API call to save
                fetch('/job-applications/api/update-job-description', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    body: JSON.stringify({
                        JobApplicationId: '@Model.JobApplicationId',
                        JobDescription: newJobDescription
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            // Handle ProblemDetails response format
                            const errorMessage = errorData.detail || errorData.error || 'Failed to save job description.';
                            throw new Error(errorMessage);
                        });
                    }    
                    return response.json();
                })
                .then(data => {
                    // Update the display with new content and original variable
                    originalJobDescription = newJobDescription;
                    $('#jobDescriptionDisplay').html(newJobDescription.replace(/\n/g, '<br>'));
                    
                    // Update the Interview Questions Manager with the new job description
                    interviewQuestionsManager.updateJobDescription(newJobDescription);
                    
                    // Switch back to display mode
                    $('#jobDescriptionDisplay').show();
                    $('#jobDescriptionEdit').hide();
                    $('#editActions').show();
                    $('#saveActions').hide();
                    
                    // Show success message
                    showSuccessMessage('Job description updated successfully!', 'jobDetailsMessages');
                })
                .catch(error => {
                    console.error('Error saving job description:', error);
                    showErrorMessage(error.message, 'jobDetailsMessages');
                })
                .finally(() => {
                    // Reset button state
                    $button.prop('disabled', false);
                    $button.html('<i class="fas fa-save me-2"></i>Save');
                });
            });
            
            // Initialize the Interview Questions Manager
            interviewQuestionsManager.init();
            
            // ===========================================
            // SHARED UTILITY FUNCTIONS
            // ===========================================
            
            function showSuccessMessage(message, containerId = 'jobDetailsMessages') {
                const successHtml = `
                    <div class="alert alert-success alert-dismissible fade show mt-2" role="alert">
                        <i class="fas fa-check-circle me-2"></i>${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                $(`#${containerId}`).prepend(successHtml);
                
                // Auto-hide after 8 seconds
                setTimeout(() => {
                    $(`#${containerId} .alert-success`).fadeOut();
                }, 8000);
            }
            
            function showErrorMessage(message, containerId = 'jobDetailsMessages') {
                const errorHtml = `
                    <div class="alert alert-danger alert-dismissible fade show mt-2" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                $(`#${containerId}`).prepend(errorHtml);
                
                // Auto-hide after 8 seconds
                setTimeout(() => {
                    $(`#${containerId} .alert-danger`).fadeOut();
                }, 8000);
            }
        });

        function confirmDelete(jobApplicationId, jobTitle) {
            if (confirm(`Are you sure you want to delete the job application for "${jobTitle}"? This action cannot be undone.`)) {
                deleteJobApplication(jobApplicationId);
            }
        }

        async function deleteJobApplication(jobApplicationId) {
            try {
                const response = await fetch(`/job-applications/api/delete/${jobApplicationId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message);
                    window.location.href = '/job-applications'; // Redirect to index page after deletion
                } else {
                    const errorData = await response.json();
                    alert(errorData.detail || 'An error occurred while deleting the job application.');
                }
            } catch (error) {
                console.error('Error deleting job application:', error);
                alert('An error occurred while deleting the job application. Please try again.');
            }
        }
    </script>
}

