@model CareerPilotAi.ViewModels.JobApplication.UserDetailsViewModel

@{
    ViewData["Title"] = "Provide Your Personal Details";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2>@ViewData["Title"]</h2>
            <p class="text-muted">Please provide your personal details for your CV. You can either enter them manually or upload a PDF file to extract the information.</p>
            
            <!-- Status messages will be displayed here dynamically through JavaScript -->
            <div id="statusMessageContainer"></div>
       
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <form asp-action="SaveUserDetails" method="post" enctype="multipart/form-data">
                <input type="hidden" asp-for="JobApplicationId" />
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Personal Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="PersonalDetails" class="form-label">
                                Enter your personal details, work experience, education, skills, and any other relevant information for your CV:
                            </label>
                            <textarea asp-for="PersonalDetails" 
                                      class="form-control" 
                                      rows="20" 
                                      placeholder="Please provide your personal details including:&#10;- Contact information&#10;- Professional summary&#10;- Work experience&#10;- Education&#10;- Skills&#10;- Certifications&#10;- Any other relevant information"></textarea>
                            <span asp-validation-for="PersonalDetails" class="text-danger"></span>
                            <div class="form-text">
                                Maximum 5,000 words. <span id="wordCount">0</span> words used.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-3">
                    <a asp-controller="JobApplication" asp-action="Index" asp-route-jobApplicationId="@Model.JobApplicationId" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back
                    </a>
                    <button type="submit" class="btn btn-primary">Finish</button>
                </div>
            </form>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Upload PDF</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Upload your existing CV in PDF format to automatically extract and populate your personal details.</p>
                    
                    <!-- Modified form to use JavaScript instead of regular form submission -->
                    <form id="pdfUploadForm" enctype="multipart/form-data">
                        <input type="hidden" id="jobApplicationId" value="@Model.JobApplicationId" />
                        @Html.AntiForgeryToken()
                        
                        <div class="mb-3">
                            <label for="pdfFile" class="form-label">Select PDF File</label>
                            <input id="pdfFile" name="PdfFile" type="file" class="form-control" accept=".pdf" single />
                            <div class="form-text">Only one PDF file can be uploaded at a time.</div>
                            <span id="pdfFileValidation" class="text-danger"></span>
                        </div>
                        
                        <button type="submit" id="processPdfBtn" class="btn btn-outline-primary w-100">
                            <i class="fas fa-file-pdf me-2"></i>Process PDF
                        </button>
                    </form>
                    
                    <!-- Loading indicator (hidden by default) -->
                    <div id="loadingIndicator" class="text-center my-3" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Processing PDF file...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/word-counter.js"></script>
    <script>
        // Initialize word counter
        const wordCounter = new WordCounter({
            textAreaSelector: 'textarea[name="PersonalDetails"]',
            wordCountSelector: '#wordCount',
            maxWords: 5000,
            warningThreshold: 4000 // Optional: can show warning near limit
        });
        
        // PDF processing functionality with fetch API
        document.addEventListener('DOMContentLoaded', function() {
            const pdfForm = document.getElementById('pdfUploadForm');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const processPdfBtn = document.getElementById('processPdfBtn');
            const statusContainer = document.getElementById('statusMessageContainer');
            const jobApplicationId = document.getElementById('jobApplicationId').value;
            const textArea = document.querySelector('textarea[name="PersonalDetails"]');
            
            pdfForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const pdfFileInput = document.getElementById('pdfFile');
                const pdfFileValidation = document.getElementById('pdfFileValidation');
                
                // Validate file selected
                if (!pdfFileInput.files || pdfFileInput.files.length === 0) {
                    pdfFileValidation.textContent = 'Please select a PDF file to upload';
                    return;
                }
                
                // Validate only one file is selected
                if (pdfFileInput.files.length > 1) {
                    pdfFileValidation.textContent = 'Only one PDF file can be uploaded at a time';
                    return;
                }
                
                // Clear previous validation message
                pdfFileValidation.textContent = '';
                
                // Show loading indicator
                loadingIndicator.style.display = 'block';
                processPdfBtn.disabled = true;
                
                // Clear any existing status messages
                statusContainer.innerHTML = '';
                
                // Create form data
                const formData = new FormData();
                formData.append('file', pdfFileInput.files[0]);
                
                // Get anti-forgery token
                const token = pdfForm.querySelector('input[name="__RequestVerificationToken"]').value;
                formData.append('__RequestVerificationToken', token);
                
                try {
                    // Create AbortController for timeout
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 seconds timeout
                    
                    // Send fetch request
                    const response = await fetch('@Url.Action("ProcessPdf", "JobApplication")', {
                        method: 'POST',
                        body: formData,
                        signal: controller.signal
                    });
                    
                    // Clear timeout as request completed
                    clearTimeout(timeoutId);
                    
                    // Process the response
                    if (response.ok) {
                        const data = await response.text();
                        
                        // Update the textarea with the extracted content
                        textArea.value = data;
                        wordCounter.validateWordCount(); // Update word count using the counter instance
                        
                        // Show success message
                        showStatusMessage('success', 'PDF processed successfully. Content has been extracted to the text area.');
                    } else {
                        // Handle HTTP error status
                        let commontOutputMessage = 'An error occurred while processing the PDF. Pdf was in the wrong format or was too big, limit is 5mb. Please update your details manually.'
                        let errorMessage = '';

                        if(response.status === 400){
                            
                            let messageFromRequest = await response.text();
                            if(messageFromRequest === null || messageFromRequest === ''){
                                errorMessage = commontOutputMessage;
                            } else {
                                errorMessage = messageFromRequest;
                            }
                        }
 
                        showStatusMessage('error', errorMessage);
                    }
                } catch (error) {
                    console.error(error);
                    // Handle different error types
                    if (error.name === 'AbortError') {
                        showStatusMessage('error', 'The request took too long to complete. Please try again or enter details manually.');
                    } else {
                        console.error('Fetch error:', error);
                        showStatusMessage('error', 'Error processing PDF: ' + error.message);
                    }
                } finally {
                    // Hide loading indicator and re-enable button
                    loadingIndicator.style.display = 'none';
                    processPdfBtn.disabled = false;
                }
            });
            
            // Helper function to display status messages
            function showStatusMessage(type, message) {
                const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
                
                statusContainer.innerHTML = `
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                
                // Scroll to the message
                statusContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    </script>
}
